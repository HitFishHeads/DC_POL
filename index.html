<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeCurrency (DC) - 去中心化民主货币系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            scroll-behavior: smooth;
        }
        :root {
            --primary-color: #81c784;
            --secondary-color: #4fc3f7;
            --accent-color: #a0d6a0;
            --sky-blue-1: #4fc3f7;
            --sky-blue-2: #81d4fa;
            --sky-blue-3: #29b6f6;
            --bg-dark: #0a0a16;
            --bg-card: rgba(15, 15, 30, 0.8);
            --bg-card-hover: rgba(20, 20, 40, 0.9);
            --bg-nav: rgba(5, 5, 16, 0.95);
            --border-color: #2d3748;
            --shadow: 0 0 25px rgba(129, 199, 132, 0.15);
            --shadow-hover: 0 0 30px rgba(129, 199, 132, 0.25);
            --sky-shadow: 0 0 20px rgba(79, 195, 247, 0.8);
            --sky-shadow-light: 0 0 10px rgba(129, 212, 250, 0.5);
        }
        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(129, 199, 132, 0.05) 0%, transparent 20%), 
                radial-gradient(circle at 90% 80%, rgba(160, 214, 160, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }
        .page-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: var(--bg-nav);
            border-right: 1px solid rgba(129, 199, 132, 0.1);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 90;
        }
        .logo {
            text-align: center;
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(129, 199, 132, 0.1);
            margin-bottom: 2rem;
        }
        .logo h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            text-shadow: 0 0 10px rgba(129, 199, 132, 0.5);
            margin-bottom: 0.5rem;
        }
        .logo p {
            color: var(--accent-color);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .nav-list {
            list-style: none;
            padding: 0 1.5rem;
        }
        .nav-item {
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .nav-link {
            display: block;
            padding: 1rem 1.2rem;
            color: #d0d0e0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-link:hover {
            background: rgba(129, 199, 132, 0.1);
            color: var(--primary-color);
            padding-left: 1.5rem;
        }
        .nav-link.active {
            background: linear-gradient(135deg, rgba(129, 199, 132, 0.15), rgba(160, 214, 160, 0.1));
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }
        #network-banner {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #050510;
            overflow: hidden;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .banner-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            padding: 0 20px;
            width: 100%;
        }
        .banner-content h1 {
            font-size: 3.8rem;
            margin-bottom: 0.8rem;
            text-shadow: var(--sky-shadow);
            background: linear-gradient(90deg, var(--sky-blue-1), var(--sky-blue-2), var(--sky-blue-3));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gradient-shift 40s ease infinite;
            background-size: 200% auto;
            line-height: 1.2;
        }
        .banner-subtitle {
            font-size: 1.8rem;
            color: var(--sky-blue-2);
            margin-bottom: 1rem;
            text-shadow: var(--sky-shadow-light);
        }
        .banner-desc {
            font-size: 1.1rem;
            color: var(--sky-blue-2);
            max-width: 900px;
            margin: 0 auto;
            opacity: 0.9;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
        }
        .banner-desc span {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .banner-desc span::before {
            content: "•";
            color: var(--sky-blue-1);
            font-size: 1.5rem;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .main-content {
            flex: 1;
            margin-left: 280px;
        }
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section {
            margin-bottom: 4rem;
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(129, 199, 132, 0.05);
            transition: all 0.3s ease;
        }
        .section:hover {
            box-shadow: var(--shadow-hover);
            border-color: rgba(129, 199, 132, 0.1);
            transform: translateY(-2px);
        }
        .section h2 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 2.5rem;
            border-bottom: 2px solid rgba(129, 199, 132, 0.1);
            padding-bottom: 0.8rem;
            position: relative;
        }
        .section h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 80px;
            height: 2px;
            background: var(--primary-color);
        }
        .section h3 {
            font-size: 1.4rem;
            color: var(--secondary-color);
            margin: 1.8rem 0 1.8rem 0;
        }
        .section p, .section li {
            font-size: 1.1rem;
            margin-bottom: 1.2rem;
            color: #d0d0e0;
            line-height: 1.8;
        }
        .section ul {
            margin-left: 2.5rem;
            margin-bottom: 1.8rem;
        }
        .highlight {
            color: var(--primary-color);
            font-weight: 600;
        }
        .code-inline {
            background: rgba(5, 5, 16, 0.5);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--accent-color);
            font-family: 'Consolas', monospace;
            font-size: 1rem;
        }
        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.8rem;
            margin-bottom: 2rem;
        }
        .block-card {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.7), rgba(15, 15, 30, 0.9));
            border-radius: 12px;
            padding: 2rem 1.8rem;
            border: 1px solid rgba(129, 199, 132, 0.1);
            box-shadow: var(--shadow);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .block-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 4px 4px 0 0;
        }
        .block-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: rgba(129, 199, 132, 0.2);
            background: var(--bg-card-hover);
        }
        .block-card h4 {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .block-card h4 i {
            font-size: 1.5rem;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(160, 214, 160, 0.1);
            border-radius: 8px;
        }
        .block-card p {
            color: #c0c0d0;
            font-size: 1rem;
            line-height: 1.7;
        }
        .steps-blocks {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .step-card {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.7), rgba(15, 15, 30, 0.9));
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid rgba(129, 199, 132, 0.1);
            box-shadow: var(--shadow);
            transition: all 0.4s ease;
            position: relative;
            padding-left: 6rem;
        }
        .step-card::before {
            content: attr(data-step);
            position: absolute;
            left: 1.8rem;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--bg-dark);
            font-weight: 700;
            font-size: 1.2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(129, 199, 132, 0.3);
        }
        .step-card::after {
            content: '';
            position: absolute;
            top: calc(50% + 20px);
            left: calc(1.8rem + 20px);
            width: 1px;
            height: calc(100% - 40px);
            background: linear-gradient(to bottom, var(--primary-color), transparent);
            opacity: 0.3;
        }
        .steps-blocks .step-card:last-child::after {
            display: none;
        }
        .step-card:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-hover);
            border-color: rgba(129, 199, 132, 0.2);
            background: var(--bg-card-hover);
        }
        .step-card h4 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .step-card p {
            color: #c0c0d0;
            font-size: 1rem;
            line-height: 1.7;
        }
        .contract-info-card {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border-left: 3px solid var(--primary-color);
            margin-bottom: 4rem;
            border: 1px solid rgba(129, 199, 132, 0.05);
        }
        .contract-info-card h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(129, 199, 132, 0.1);
            padding-bottom: 1rem;
        }
        .contract-info-card p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #d0d0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .contract-info-card .highlight {
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(129, 199, 132, 0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
        }
        .wallet-connect-area {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .wallet-select {
            padding: 1rem 1.2rem;
            background: var(--bg-card);
            border: 1px solid rgba(129, 199, 132, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        .wallet-select option {
            background: var(--bg-dark);
            color: #e0e0e0;
        }
        .wallet-connect-btn {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--bg-dark);
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .wallet-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(129, 199, 132, 0.1);
            box-shadow: var(--shadow);
        }
        .wallet-name {
            color: var(--primary-color);
            font-weight: 600;
        }
        .wallet-address {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .address-text {
            color: #d0d0e0;
        }
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        .copy-btn:hover {
            color: var(--sky-blue-1);
        }
        .disconnect-btn {
            padding: 0.8rem 1.5rem;
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .disconnect-btn:hover {
            background: rgba(244, 67, 54, 0.2);
            transform: translateY(-2px);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .info-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(129, 199, 132, 0.1);
            box-shadow: var(--shadow);
        }
        .info-card h4 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-card h4 i {
            font-size: 1.1rem;
            color: var(--accent-color);
        }
        .info-card .status {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block;
            margin-top: 0.5rem;
        }
        .status.positive {
            background: rgba(129, 199, 132, 0.1);
            color: var(--primary-color);
        }
        .status.negative {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        .status.neutral {
            background: rgba(79, 195, 247, 0.1);
            color: var(--secondary-color);
        }
        .claim-btn {
            margin-top: 1rem;
            padding: 0.6rem 1.5rem;
            background: linear-gradient(135deg, var(--sky-blue-1), var(--sky-blue-2));
            color: #0a0a16;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--sky-shadow);
        }
        .claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .copy-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            box-shadow: var(--shadow);
            color: #e0e0e0;
            display: none;
            z-index: 1000;
            animation: toastIn 0.3s ease-in-out;
        }
        @keyframes toastIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @media (max-width: 1200px) {
            .sidebar { width: 250px; }
            .main-content { margin-left: 250px; }
            .banner-content h1 { font-size: 3rem; }
            .banner-subtitle { font-size: 1.5rem; }
            .blocks-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        }
        @media (max-width: 768px) {
            .page-container { flex-direction: column; }
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid rgba(129, 199, 132, 0.1);
                padding: 1rem 0;
            }
            .logo { padding: 0 1rem 1rem; margin-bottom: 1rem; }
            .nav-list {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
                gap: 0.5rem;
            }
            .nav-item { white-space: nowrap; }
            .main-content { margin-left: 0; }
            #network-banner { height: 300px; }
            .banner-content h1 { font-size: 2.2rem; }
            .banner-subtitle { font-size: 1.2rem; }
            .banner-desc {
                font-size: 0.9rem;
                gap: 1rem;
                flex-direction: column;
                align-items: center;
            }
            .content-wrapper { padding: 2rem 1rem; }
            .section { padding: 2rem 1.5rem; }
            .section h2 { font-size: 1.8rem; }
            .blocks-grid { grid-template-columns: 1fr; }
            .step-card {
                padding-left: 4.5rem;
            }
            .step-card::before {
                left: 1rem;
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            .step-card::after {
                left: calc(1rem + 17.5px);
            }
            .contract-info-card { padding: 1.5rem; }
            .contract-info-card p {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .info-grid { grid-template-columns: 1fr; }
            .wallet-connect-area {
                flex-direction: column;
                align-items: stretch;
            }
            .wallet-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <div class="page-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>DeCurrency (DC)</h2>
                <p>去中心化民主货币系统</p>
            </div>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#concept-page" class="nav-link active" data-page="concept-page">核心理念</a>
                </li>
                <li class="nav-item">
                    <a href="#participate-page" class="nav-link" data-page="participate-page">参与和治理</a>
                </li>
                <li class="nav-item">
                    <a href="#profile-page" class="nav-link" data-page="profile-page">个人信息</a>
                </li>
            </ul>
        </aside>
        <main class="main-content">
            <div id="network-banner">
                <canvas id="networkCanvas"></canvas>
                <div class="banner-content">
                    <h1>DeCurrency (DC)</h1>
                    <div class="banner-subtitle">去中心化民主货币</div>
                    <div class="banner-desc">
                        <span>基于Polygon主网的去中心化身份验证</span>
                        <span>社区治理代币体系</span>
                        <span>以个人主权为核心构建生态</span>
                    </div>
                </div>
            </div>
            <div class="content-wrapper">
                <div id="concept-page" class="page active">
                    <section class="section">
                        <h2>DC代币系统核心理念</h2>
                        <p>DeCurrency（DC）代币是部署在<strong class="highlight">Polygon主网</strong>的去中心化代币系统，其核心理念是<strong class="highlight">“个人主权货币”与“民主自治治理”</strong>，打破传统中心化机构的垄断，让每个参与者拥有平等的身份权和治理权。</p>
                        <p style="margin-top: 1.5rem; margin-bottom: 2rem;">与传统代币不同，DC代币系统融合了四大核心设计，旨在构建一个可持续、去中心化、由社区自主管理的货币生态：</p>
                        <div class="blocks-grid">
                            <div class="block-card">
                                <h4><i class="fas fa-user-shield"></i>个人主权优先</h4>
                                <p>身份是参与系统的基础，只有通过验证的用户才能享受铸造代币、投票等核心权益，保障每个参与者的真实主权。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-balance-scale"></i>动态平衡机制</h4>
                                <p>引入代币月度衰减机制（每月千分之3），避免代币囤积，促进代币流通。合约中通过<code class="code-inline">decck()</code>函数实现余额衰减检查，确保生态的流动性。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-users-cog"></i>社区自治治理</h4>
                                <p>验证者由社区成员竞争产生，重大决策（身份验证）由验证者投票决定，实现真正的去中心化治理。系统限定验证者数量为200人，保证治理效率。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-list-check"></i>初始白名单过渡</h4>
                                <p>系统初期设置10000个白名单名额用于构建初始社区，创建者可通过<code class="code-inline">whitevote()</code>函数直接验证用户身份；待生态成熟后，可调用<code class="code-inline">dropwhitelist()</code>函数放弃权限，完全交由社区自治。</p>
                            </div>
                        </div>
                    </section>
                </div>
                <div id="participate-page" class="page">
                    <div class="contract-info-card">
                        <h3>合约基础信息</h3>
                        <p>网络：<span class="highlight">Polygon主网</span></p>
                        <p>合约地址：<span class="highlight">0x8Cb3bA05Efa695799E1cF0A2d2921e2387CbFB2C</span></p>
                        <p>代币名称：<span class="highlight">DeCurrency (DC)</span></p>
                        <p>代币小数位：<span class="highlight">2位</span></p>
                    </div>
                    <section class="section">
                        <h2>如何获取DC系统身份</h2>
                        <p>在DC系统中，<strong class="highlight">“已验证身份”</strong>是参与所有核心功能的前提（如铸造代币、成为验证者、参与投票），获取身份需完成以下步骤：</p>
                        <div class="steps-blocks">
                            <div class="step-card" data-step="1">
                                <h4>准备足够的DC代币</h4>
                                <p>申请身份验证需要消耗<strong class="highlight">5000 DC代币</strong>（需注意代币会有月度衰减，需提前调用<code class="code-inline">refreshbalance()</code>函数刷新余额确保数量充足）。</p>
                            </div>
                            <div class="step-card" data-step="2">
                                <h4>提交身份认证申请</h4>
                                <p>调用合约的<code class="code-inline">application(string memory _URL)</code>函数，传入能证明自身身份的视频/文件网络地址（供验证者审核），提交后会进入申请列表（列表上限200人），状态变为“申请中”。</p>
                            </div>
                            <div class="step-card" data-step="3">
                                <h4>等待验证者投票审核</h4>
                                <p>验证者会对申请进行投票，当同意+反对票数达到100票时，若同意票多于反对票，身份验证通过；否则申请失败。（注：系统初期创建者可通过白名单直接验证身份，白名单用完后完全由社区投票决定）</p>
                            </div>
                            <div class="step-card" data-step="4">
                                <h4>身份的有效期与续签</h4>
                                <p>已验证身份的有效期为<strong class="highlight">1年</strong>，若超过1年未重新验证，身份会失效，需重新提交申请。合约中通过<code class="code-inline">lastverifiedtime</code>变量记录上次认证时间，判断身份是否有效。</p>
                            </div>
                        </div>
                        <p style="margin-top: 2rem;">身份验证通过后，你将获得以下核心权益：</p>
                        <div class="blocks-grid" style="margin-top: 1.5rem;">
                            <div class="block-card">
                                <h4><i class="fas fa-coins"></i>每日铸造代币</h4>
                                <p>每日可铸造<strong class="highlight">1000 DC代币</strong>（需间隔24小时，调用<code class="code-inline">claim()</code>函数执行铸造）。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-user-check"></i>成为验证者</h4>
                                <p>可申请成为验证者，参与社区治理投票，拥有审核其他用户身份的权限。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-vote-yea"></i>参与投票奖励</h4>
                                <p>可参与其他用户的身份验证投票，若投票结果与最终结果一致，可获得相应的代币奖励。</p>
                            </div>
                        </div>
                    </section>
                    <section class="section">
                        <h2>如何成为验证者并参与投票治理</h2>
                        <p>验证者是DC系统的治理核心，负责审核用户的身份申请，系统限定验证者数量为<strong class="highlight">200人</strong>，成为验证者并参与投票需遵循以下规则：</p>
                        <h3>3.1 成为验证者的条件与流程</h3>
                        <div class="blocks-grid">
                            <div class="block-card">
                                <h4><i class="fas fa-check-circle"></i>前提条件</h4>
                                <p>必须拥有<strong class="highlight">已验证的有效身份</strong>，且尚未成为验证者。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-plus-circle"></i>填补空缺流程</h4>
                                <p>若验证者列表中有空位置（地址为0），调用<code class="code-inline">bevoter()</code>函数可直接成为验证者。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-exchange-alt"></i>竞争取代流程</h4>
                                <p>若列表已满，需满足以下任一条件即可取代现有验证者：<br>1. 你的7天最小DC余额（<code class="code-inline">minbalanceOf</code>）高于目标验证者；<br>2. 目标验证者超过7天未参与投票，且成为验证者已超过1小时。</p>
                            </div>
                        </div>
                        <h3>3.2 参与投票的规则与奖励</h3>
                        <div class="blocks-grid">
                            <div class="block-card">
                                <h4><i class="fas fa-lock"></i>投票前提</h4>
                                <p>验证者需拥有至少<strong class="highlight">1000 DC代币</strong>（投票时会消耗该数量代币），且身份处于有效状态，距离上次投票至少5分钟。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-clipboard-check"></i>投票流程</h4>
                                <p>调用合约的<code class="code-inline">vote(address _Address, bool approv)</code>函数，选择对某个申请者投同意票（true）或反对票（false），投票后进入“投票中”状态。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-gift"></i>投票奖励</h4>
                                <p>当申请者投票达到100票后，验证者调用<code class="code-inline">getrewards()</code>函数领取奖励：<br>1. 投票结果一致：获得<strong class="highlight">2000 DC代币</strong>；<br>2. 结果不一致：无奖励且消耗的代币不返还。</p>
                            </div>
                            <div class="block-card">
                                <h4><i class="fas fa-exclamation-triangle"></i>验证者义务</h4>
                                <p>验证者需定期参与投票，若超过7天未投票，将被移出验证者列表，失去治理权限。合约中通过<code class="code-inline">lastvotetime</code>变量记录上次投票时间。</p>
                            </div>
                        </div>
                    </section>
                </div>
                <div id="profile-page" class="page">
                    <section class="section">
                        <h2>个人信息中心</h2>
                        <div class="wallet-connect-area">
                            <select class="wallet-select" id="walletSelect">
                                <option value="">请选择钱包</option>
                                <option value="metamask">MetaMask</option>
                                <option value="okx">OKX Wallet</option>
                            </select>
                            <button class="wallet-connect-btn" id="connectWalletBtn">
                                <i class="fas fa-link"></i> <span id="connectBtnText">连接 Polygon 钱包</span>
                            </button>
                            <div class="wallet-info" id="walletInfo" style="display: none;">
                                <span class="wallet-name" id="walletName">钱包</span>
                                <div class="wallet-address">
                                    <span class="address-text" id="walletAddress">0x...</span>
                                    <button class="copy-btn" id="copyBtn" title="复制地址">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="disconnect-btn" id="disconnectBtn" style="display: none;">
                                <i class="fas fa-unlink"></i> 断开钱包
                            </button>
                        </div>
                        <div id="walletNotConnected" class="wallet-not-connected">
                            <p>请先连接你的Polygon钱包，以查看个人资产和身份状态信息。</p>
                        </div>
                        <div id="profileInfo" style="display: none;">
                            <div class="info-grid">
                                <div class="info-card">
                                    <h4><i class="fas fa-coins"></i> 我的DC代币数量</h4>
                                    <p id="tokenBalance">0.00 DC</p>
                                </div>
                                <div class="info-card">
                                    <h4><i class="fas fa-user-check"></i> 身份认证状态</h4>
                                    <p>当前状态：<span id="verifyStatus" class="status negative">未认证</span></p>
                                </div>
                                <div class="info-card">
                                    <h4><i class="fas fa-vote-yea"></i> 投票权状态</h4>
                                    <p>当前状态：<span id="voteStatus" class="status negative">无投票权</span></p>
                                    <p>7天最低余额：<span id="minBalance">--</span> DC</p>
                                </div>
                                <div class="info-card">
                                    <h4><i class="fas fa-hammer"></i> 铸造代币板块</h4>
                                    <div id="mintStatusBlock"></div>
                                </div>
                            </div>

                            <!-- 提交身份认证板块 -->
                            <div class="section" id="applySection" style="margin-top: 2rem; display: none;">
                                <h3> 提交身份认证申请</h3>
                                <p>需消耗 <strong class="highlight">5000 DC</strong>，提交一个证明你身份的视频或文件链接。</p>
                                <input type="url" id="identityURL" placeholder="请输入身份证明文件的公开URL（如 Google Drive、IPFS 等）" style="width: 100%; padding: 0.8rem; margin: 1rem 0; background: var(--bg-card); color: #e0e0e0; border: 1px solid rgba(129,199,132,0.1); border-radius: 6px;">
                                <button class="claim-btn" id="applyBtn" style="background: linear-gradient(135deg, #ff9800, #ffb74d);">
                                    <i class="fas fa-file-upload"></i> 提交身份认证
                                </button>
                                <div id="applyStatus" style="margin-top: 1rem;"></div>
                            </div>

                            <!-- 获取投票权板块 -->
                            <div class="section" id="voterSection" style="display: none;">
                                <h3>获取投票权（成为验证者）</h3>
                                <p>验证者可审核他人身份申请。需满足：<br>✅ 已认证身份 &nbsp; ✅ 7天最低余额足够高</p>
                                <button class="claim-btn" id="becomeVoterBtn" style="background: linear-gradient(135deg, #9c27b0, #e040fb);">
                                    <i class="fas fa-user-shield"></i> 申请成为验证者
                                </button>
                                <div id="voterStatus" style="margin-top: 1rem;"></div>
                            </div>

                            <!-- 参与投票 -->
                            <div class="section">
                                <h3>参与投票（审核身份申请）</h3>
                                <div id="pendingApplication" style="margin-top: 1rem;"></div>
                            </div>

                            <!-- 我的投票进度 -->
                            <div class="section">
                                <h3> 我的投票进度</h3>
                                <div id="myVoteProgress" style="margin-top: 1rem;"></div>
                            </div>

                            <!-- 领取投票奖励 -->
                            <div class="section">
                                <h3> 领取投票奖励</h3>
                                <p>投票结果一致可领取 <strong class="highlight">2000 DC</strong> 奖励。</p>
                                <button class="claim-btn" id="claimRewardBtn" style="background: linear-gradient(135deg, #00bcd4, #80deea);">
                                    <i class="fas fa-gift"></i> 领取投票奖励
                                </button>
                                <div id="rewardStatus" style="margin-top: 1rem;"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>
    <div class="copy-toast" id="copyToast">地址复制成功！</div>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // ========== Canvas 动画 ==========
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                initNodesAndLights();
            }
            window.addEventListener('resize', resizeCanvas);
            let nodes = [];
            let lights = [];
            const maxDistance = 150;
            class Node {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.radius = Math.random() * 2 + 1;
                    this.speedX = (Math.random() - 0.5) * 0.3;
                    this.speedY = (Math.random() - 0.5) * 0.3;
                    this.color = 'rgba(129, 199, 132, 0.8)';
                    this.lightness = Math.random() * 0.5 + 0.5;
                }
                update() {
                    if (this.x < 0 || this.x > canvas.width) this.speedX = -this.speedX;
                    if (this.y < 0 || this.y > canvas.height) this.speedY = -this.speedY;
                    this.x += this.speedX;
                    this.y += this.speedY;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    for (let i = 1; i <= 5; i++) {
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.radius * i * this.lightness, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(129, 199, 132, ${0.04 * this.lightness / i})`;
                        ctx.fill();
                    }
                }
            }
            class Light {
                constructor(fromNode, toNode) {
                    this.fromNode = fromNode;
                    this.toNode = toNode;
                    this.progress = Math.random();
                    this.speed = (Math.random() * 0.001 + 0.0004) * 3;
                    this.color = 'rgba(129, 199, 132, 0.8)';
                    this.trailLength = Math.random() * 5 + 3;
                }
                update() {
                    this.progress += this.speed;
                    if (this.progress > 1) {
                        this.progress = 0;
                    }
                }
                draw() {
                    const x = this.fromNode.x + (this.toNode.x - this.fromNode.x) * this.progress;
                    const y = this.fromNode.y + (this.toNode.y - this.fromNode.y) * this.progress;
                    ctx.beginPath();
                    ctx.arc(x, y, 0.3, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    for (let i = 1; i <= this.trailLength; i++) {
                        const trailProgress = this.progress - (i * 0.02);
                        if (trailProgress > 0) {
                            const tx = this.fromNode.x + (this.toNode.x - this.fromNode.x) * trailProgress;
                            const ty = this.fromNode.y + (this.toNode.y - this.fromNode.y) * trailProgress;
                            const radius = (4 - (i * 0.5)) * 0.2;
                            ctx.beginPath();
                            ctx.arc(tx, ty, radius, 0, Math.PI * 2);
                            ctx.fillStyle = `rgba(129, 199, 132, ${0.1 - (i * 0.06)})`;
                            ctx.fill();
                        }
                    }
                }
            }
            function initNodesAndLights() {
                nodes = [];
                lights = [];
                const nodeCount = Math.floor((canvas.width * canvas.height) / 12000);
                for (let i = 0; i < nodeCount; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    nodes.push(new Node(x, y));
                }
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const dx = nodes[i].x - nodes[j].x;
                        const dy = nodes[i].y - nodes[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < maxDistance && Math.random() < 0.2) {
                            lights.push(new Light(nodes[i], nodes[j]));
                        }
                    }
                }
            }
            function animate() {
                requestAnimationFrame(animate);
                ctx.fillStyle = 'rgba(5, 5, 16, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                nodes.forEach(node => {
                    node.update();
                    node.draw();
                });
                ctx.strokeStyle = 'rgba(129, 199, 132, 0.1)';
                ctx.lineWidth = 0.5;
                nodes.forEach((node, i) => {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const dx = node.x - nodes[j].x;
                        const dy = node.y - nodes[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < maxDistance) {
                            const opacity = 0.1 - (distance / maxDistance) * 0.08;
                            ctx.strokeStyle = `rgba(129, 199, 132, ${opacity})`;
                            ctx.beginPath();
                            ctx.moveTo(node.x, node.y);
                            ctx.lineTo(nodes[j].x, nodes[j].y);
                            ctx.stroke();
                        }
                    }
                });
                lights.forEach(light => {
                    light.update();
                    light.draw();
                });
            }
            resizeCanvas();
            animate();

            // ========== 页面切换 ==========
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    pages.forEach(p => p.classList.remove('active'));
                    const targetPage = link.getAttribute('data-page');
                    link.classList.add('active');
                    document.getElementById(targetPage).classList.add('active');
                });
            });

            // ========== 钱包与合约逻辑 ==========
            let provider = null;
            let signer = null;
            let userAddress = null;
            let currentWallet = null;
            const DC_CONTRACT_ADDRESS = '0x8Cb3bA05Efa695799E1cF0A2d2921e2387CbFB2C';
            const DC_CONTRACT_ABI = [
                'function balanceOf(address) view returns (uint256)',
                'function decimals() view returns (uint8)',
                'function verified(address) view returns (bool)',
                'function lastclaimtime(address) view returns (uint256)',
                'function claim()',
                'function minbalanceOf(address) view returns (uint256)',
                'function voter(address) view returns (bool)',
                'function refreshapplicants() view returns (uint256)',
                'function get_address_from_applylist(uint256) view returns (address)',
                'function application_URL(address) view returns (string)',
                'function agree(address) view returns (uint256)',
                'function opposition(address) view returns (uint256)',
                'function voting(address) view returns (bool)',
                'function voteto(address) view returns (address)',
                'function voteto_pass(address) view returns (bool)',
                'function isappling(address) view returns (bool)',
                'function application(string memory _URL)',
                'function bevoter()',
                'function vote(address _Address, bool approv)',
                'function getrewards()'
            ];
            const POLYGON_CHAIN_ID = 137;
            const CLAIM_COOLDOWN = 86400;

            const walletSelect = document.getElementById('walletSelect');
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const connectBtnText = document.getElementById('connectBtnText');
            const walletNotConnected = document.getElementById('walletNotConnected');
            const profileInfo = document.getElementById('profileInfo');
            const walletInfo = document.getElementById('walletInfo');
            const walletNameEl = document.getElementById('walletName');
            const walletAddress = document.getElementById('walletAddress');
            const copyBtn = document.getElementById('copyBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const copyToast = document.getElementById('copyToast');
            const mintStatusBlock = document.getElementById('mintStatusBlock');

            if (typeof ethers === 'undefined') {
                alert('ethers.js库加载失败，请检查网络！');
                connectWalletBtn.disabled = true;
                return;
            }

            function getInjectedProvider(walletType) {
                if (walletType === 'okx' && window.okxwallet) {
                    return window.okxwallet;
                } else if (walletType === 'metamask' && window.ethereum) {
                    return window.ethereum;
                } else if (!walletType && window.ethereum) {
                    return window.ethereum;
                }
                return null;
            }

            async function switchToPolygonNetwork(providerInstance) {
                try {
                    await providerInstance.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x89' }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await providerInstance.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x89',
                                chainName: 'Polygon Mainnet',
                                nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                rpcUrls: ['https://polygon-rpc.com/'],
                                blockExplorerUrls: ['https://polygonscan.com/']
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }

            connectWalletBtn.addEventListener('click', async () => {
                const selectedWallet = walletSelect.value;
                if (!selectedWallet) {
                    alert('请选择一个钱包类型');
                    return;
                }

                const providerInstance = getInjectedProvider(selectedWallet);
                if (!providerInstance) {
                    if (selectedWallet === 'okx') {
                        alert('请安装 OKX 钱包插件（https://www.okx.com/zh-hans/web3）');
                    } else {
                        alert('请安装 MetaMask 钱包插件');
                    }
                    return;
                }

                try {
                    connectBtnText.textContent = '连接中...';
                    connectWalletBtn.disabled = true;

                    const accounts = await providerInstance.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    currentWallet = selectedWallet;

                    const chainId = await providerInstance.request({ method: 'eth_chainId' });
                    if (parseInt(chainId, 16) !== POLYGON_CHAIN_ID) {
                        await switchToPolygonNetwork(providerInstance);
                    }

                    provider = new ethers.providers.Web3Provider(providerInstance);
                    signer = provider.getSigner();

                    updateWalletInfo(selectedWallet);
                    await getUserProfileData();
                } catch (error) {
                    console.error('连接失败：', error);
                    alert(`连接失败：${error.message || '用户拒绝连接'}`);
                    connectBtnText.textContent = '连接 Polygon 钱包';
                    connectWalletBtn.disabled = false;
                }
            });

            disconnectBtn.addEventListener('click', () => {
                provider = null;
                signer = null;
                userAddress = null;
                currentWallet = null;
                walletInfo.style.display = 'none';
                disconnectBtn.style.display = 'none';
                profileInfo.style.display = 'none';
                walletNotConnected.style.display = 'block';
                connectBtnText.textContent = '连接 Polygon 钱包';
                connectWalletBtn.disabled = false;
                walletSelect.value = '';
                mintStatusBlock.innerHTML = '';
                document.getElementById('applyStatus').innerHTML = '';
                document.getElementById('voterStatus').innerHTML = '';
                document.getElementById('pendingApplication').innerHTML = '';
                document.getElementById('myVoteProgress').innerHTML = '';
                document.getElementById('rewardStatus').innerHTML = '';
                if (window.mintCountdownInterval) {
                    clearInterval(window.mintCountdownInterval);
                    window.mintCountdownInterval = null;
                }
            });

            copyBtn.addEventListener('click', async () => {
                if (!userAddress) return;
                try {
                    await navigator.clipboard.writeText(userAddress);
                    copyToast.style.display = 'block';
                    setTimeout(() => copyToast.style.display = 'none', 3000);
                } catch (err) {
                    alert('复制失败，请手动复制！');
                }
            });

            function updateWalletInfo(walletType) {
                walletNotConnected.style.display = 'none';
                profileInfo.style.display = 'block';
                walletInfo.style.display = 'flex';
                disconnectBtn.style.display = 'block';

                const walletNames = { metamask: 'MetaMask', okx: 'OKX Wallet' };
                const walletName = walletNames[walletType] || '钱包';
                walletNameEl.textContent = walletName;

                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                walletAddress.textContent = shortAddress;
                walletAddress.setAttribute('title', userAddress);
                connectBtnText.textContent = '钱包已连接';
                connectWalletBtn.style.background = 'linear-gradient(135deg, #4caf50, #81c784)';
            }

            async function getUserProfileData() {
                if (!provider || !userAddress) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, provider);
                    const [
                        balance,
                        decimals,
                        isVerified,
                        lastClaimTime,
                        minBalance,
                        isVoter,
                        isApplying
                    ] = await Promise.all([
                        contract.balanceOf(userAddress),
                        contract.decimals(),
                        contract.verified(userAddress),
                        contract.lastclaimtime(userAddress),
                        contract.minbalanceOf(userAddress),
                        contract.voter(userAddress),
                        contract.isappling(userAddress)
                    ]);

                    const formattedBalance = ethers.utils.formatUnits(balance, decimals);
                    document.getElementById('tokenBalance').textContent = `${parseFloat(formattedBalance).toFixed(2)} DC`;

                    const verifyStatusEl = document.getElementById('verifyStatus');
                    if (isVerified) {
                        verifyStatusEl.className = 'status positive';
                        verifyStatusEl.textContent = '已认证';
                        document.getElementById('applySection').style.display = 'none';
                    } else if (isApplying) {
                        verifyStatusEl.className = 'status neutral';
                        verifyStatusEl.textContent = '认证中';
                        document.getElementById('applySection').style.display = 'none';
                    } else {
                        verifyStatusEl.className = 'status negative';
                        verifyStatusEl.textContent = '未认证';
                        document.getElementById('applySection').style.display = 'block';
                    }

                    const voteStatusEl = document.getElementById('voteStatus');
                    if (isVoter) {
                        voteStatusEl.className = 'status positive';
                        voteStatusEl.textContent = '拥有投票权';
                        document.getElementById('voterSection').style.display = 'none';
                    } else {
                        voteStatusEl.className = 'status negative';
                        voteStatusEl.textContent = '无投票权';
                        document.getElementById('voterSection').style.display = 'block';
                    }

                    document.getElementById('minBalance').textContent = (parseFloat(ethers.utils.formatUnits(minBalance, decimals)) || 0).toFixed(2);

                    await handleMintStatus(isVerified, lastClaimTime.toNumber(), contract);
                    await loadPendingApplication();
                    await loadMyVoteProgress();
                } catch (error) {
                    console.error('获取用户数据失败：', error);
                    alert(`获取数据失败：${error.message}`);
                }
            }

            async function handleMintStatus(isVerified, lastClaimTimestamp, contract) {
                const now = Math.floor(Date.now() / 1000);
                let htmlContent = '';
                if (!isVerified) {
                    htmlContent = '<span class="status negative">身份未认证，不可铸造</span>';
                    mintStatusBlock.innerHTML = htmlContent;
                    if (window.mintCountdownInterval) {
                        clearInterval(window.mintCountdownInterval);
                        window.mintCountdownInterval = null;
                    }
                    return;
                }
                const nextClaimTimestamp = lastClaimTimestamp + CLAIM_COOLDOWN;
                if (now >= nextClaimTimestamp) {
                    htmlContent = `
                        <span class="status positive">可铸造</span>
                        <button class="claim-btn" id="claimBtn">
                            <i class="fas fa-coins"></i> 铸造 1000 DC
                        </button>
                    `;
                    mintStatusBlock.innerHTML = htmlContent;
                    document.getElementById('claimBtn').addEventListener('click', () => claimTokens(contract));
                } else {
                    htmlContent = `
                        <span class="status neutral" id="countdownText">计算中...</span>
                    `;
                    mintStatusBlock.innerHTML = htmlContent;
                    updateMintCountdownDisplay(nextClaimTimestamp);
                    if (window.mintCountdownInterval) clearInterval(window.mintCountdownInterval);
                    window.mintCountdownInterval = setInterval(() => {
                        const currentTime = Math.floor(Date.now() / 1000);
                        if (currentTime >= nextClaimTimestamp) {
                            getUserProfileData();
                        } else {
                            updateMintCountdownDisplay(nextClaimTimestamp);
                        }
                    }, 1000);
                }
            }

            function updateMintCountdownDisplay(nextClaimTimestamp) {
                const now = Math.floor(Date.now() / 1000);
                const diff = nextClaimTimestamp - now;
                if (diff <= 0) {
                    mintStatusBlock.innerHTML = '<span class="status neutral">即将可铸造</span>';
                    return;
                }
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                const countdownText = document.getElementById('countdownText');
                if (countdownText) {
                    countdownText.textContent = `可铸造还需 ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }

            async function claimTokens(contract) {
                try {
                    const claimBtn = document.getElementById('claimBtn');
                    if (!claimBtn) return;
                    claimBtn.disabled = true;
                    claimBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 铸造中...';
                    const gasLimit = 1500000;
                    const feeData = await provider.getFeeData();
                    const tx = await contract.connect(signer).claim({
                        gasLimit: gasLimit,
                        ...(feeData.maxFeePerGas ? {
                            maxFeePerGas: feeData.maxFeePerGas,
                            maxPriorityFeePerGas: feeData.maxPriorityFeePerGas || ethers.utils.parseUnits("20", "gwei")
                        } : {
                            gasPrice: feeData.gasPrice || ethers.utils.parseUnits("20", "gwei")
                        })
                    });
                    await tx.wait();
                    alert('✅ 铸造成功！已领取 1000 DC。');
                    await getUserProfileData();
                } catch (error) {
                    console.error('铸造失败:', error);
                    if (error.code === 'ACTION_REJECTED') {
                        alert('❌ 您取消了交易。');
                    } else if (error.code === 'INSUFFICIENT_FUNDS') {
                        alert('❌ Gas 费不足，请确保钱包有足够 MATIC。');
                    } else {
                        alert(`❌ 铸造失败：${error.reason || error.message || '未知错误'}`);
                    }
                    const btn = document.getElementById('claimBtn');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-coins"></i> 铸造 1000 DC';
                    }
                }
            }

            // ========== 新增功能 ==========
            document.getElementById('applyBtn')?.addEventListener('click', async () => {
                const url = document.getElementById('identityURL').value.trim();
                if (!url) {
                    alert('请输入有效的身份证明URL');
                    return;
                }
                if (!provider || !signer || !userAddress) {
                    alert('请先连接钱包');
                    return;
                }
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, signer);
                    const tx = await contract.application(url);
                    document.getElementById('applyStatus').innerHTML = '<span class="status neutral">提交中...请等待交易确认</span>';
                    await tx.wait();
                    document.getElementById('applyStatus').innerHTML = '<span class="status positive">✅ 身份认证申请已提交！</span>';
                    getUserProfileData();
                } catch (err) {
                    console.error(err);
                    document.getElementById('applyStatus').innerHTML = `<span class="status negative">❌ 提交失败：${err.reason || err.message}</span>`;
                }
            });

            document.getElementById('becomeVoterBtn')?.addEventListener('click', async () => {
                if (!provider || !signer || !userAddress) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, signer);
                    const tx = await contract.bevoter();
                    document.getElementById('voterStatus').innerHTML = '<span class="status neutral">申请中...</span>';
                    await tx.wait();
                    document.getElementById('voterStatus').innerHTML = '<span class="status positive">✅ 已成为验证者！</span>';
                    getUserProfileData();
                } catch (err) {
                    console.error(err);
                    document.getElementById('voterStatus').innerHTML = `<span class="status negative">❌ 申请失败：${err.reason || err.message}</span>`;
                }
            });

            async function loadPendingApplication() {
                if (!provider || !userAddress) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, provider);
                    const count = await contract.refreshapplicants();
                    if (count.toNumber() === 0) {
                        document.getElementById('pendingApplication').innerHTML = '<p>暂无待审核的身份申请。</p>';
                        return;
                    }
                    const firstApplicant = await contract.get_address_from_applylist(0);
                    const url = await contract.application_URL(firstApplicant);
                    const agree = await contract.agree(firstApplicant);
                    const oppose = await contract.opposition(firstApplicant);
                    const total = agree.add(oppose).toNumber();

                    let html = `<p><strong>申请人地址：</strong>${firstApplicant}</p>`;
                    html += `<p><strong>身份证明链接：</strong><a href="${url}" target="_blank" style="color:var(--accent-color);">${url || '无'}</a></p>`;
                    html += `<p><strong>当前投票：</strong>同意 ${agree.toNumber()} 票，反对 ${oppose.toNumber()} 票（共 ${total} 票）</p>`;

                    if (total < 100) {
                        const isVoter = await contract.voter(userAddress);
                        const isVerified = await contract.verified(userAddress);
                        if (isVoter && isVerified) {
                            html += `<button class="claim-btn" id="voteApproveBtn" data-addr="${firstApplicant}" style="margin-right:1rem;">同意</button>`;
                            html += `<button class="claim-btn" id="voteRejectBtn" data-addr="${firstApplicant}" style="background:linear-gradient(135deg, #f44336, #ff8a80);">反对</button>`;
                        } else {
                            html += `<p class="status neutral">您需要成为验证者并完成身份认证才能投票。</p>`;
                        }
                    } else {
                        html += `<p class="status neutral">该申请已结束投票。</p>`;
                    }
                    document.getElementById('pendingApplication').innerHTML = html;

                    document.getElementById('voteApproveBtn')?.addEventListener('click', () => castVote(firstApplicant, true));
                    document.getElementById('voteRejectBtn')?.addEventListener('click', () => castVote(firstApplicant, false));
                } catch (err) {
                    console.error('加载申请失败:', err);
                    document.getElementById('pendingApplication').innerHTML = `<p class="status negative">加载失败：${err.message}</p>`;
                }
            }

            async function castVote(target, approve) {
                if (!signer) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, signer);
                    const tx = await contract.vote(target, approve);
                    alert(`正在提交${approve ? '同意' : '反对'}票...`);
                    await tx.wait();
                    alert('投票成功！');
                    loadPendingApplication();
                    loadMyVoteProgress();
                } catch (err) {
                    console.error(err);
                    alert(`投票失败：${err.reason || err.message}`);
                }
            }

            async function loadMyVoteProgress() {
                if (!provider || !userAddress) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, provider);
                    const isVoting = await contract.voting(userAddress);
                    if (!isVoting) {
                        document.getElementById('myVoteProgress').innerHTML = '<p>您当前未参与投票。</p>';
                        return;
                    }
                    const target = await contract.voteto(userAddress);
                    const myVote = await contract.voteto_pass(userAddress);
                    const agree = await contract.agree(target);
                    const oppose = await contract.opposition(target);
                    const total = agree.add(oppose).toNumber();
                    const isApplying = await contract.isappling(target);

                    let html = `<p>您正在对 <strong>${target}</strong> 进行投票</p>`;
                    html += `<p>您的投票：${myVote ? '同意' : '反对'}</p>`;
                    html += `<p>当前票数：同意 ${agree.toNumber()}，反对 ${oppose.toNumber()}（共 ${total} 票）</p>`;
                    if (!isApplying || total >= 100) {
                        html += `<p class="status positive">投票已结束！</p>`;
                    }
                    document.getElementById('myVoteProgress').innerHTML = html;
                } catch (err) {
                    console.error('加载投票进度失败:', err);
                    document.getElementById('myVoteProgress').innerHTML = `<p class="status negative">加载失败：${err.message}</p>`;
                }
            }

            document.getElementById('claimRewardBtn')?.addEventListener('click', async () => {
                if (!provider || !signer || !userAddress) return;
                try {
                    const contract = new ethers.Contract(DC_CONTRACT_ADDRESS, DC_CONTRACT_ABI, signer);
                    const tx = await contract.getrewards();
                    document.getElementById('rewardStatus').innerHTML = '<span class="status neutral">领取中...</span>';
                    await tx.wait();
                    document.getElementById('rewardStatus').innerHTML = '<span class="status positive">✅ 奖励已领取！</span>';
                    getUserProfileData();
                } catch (err) {
                    console.error(err);
                    document.getElementById('rewardStatus').innerHTML = `<span class="status negative">❌ 领取失败：${err.reason || err.message}</span>`;
                }
            });

            // ========== 自动检测已连接钱包 ==========
            if (window.ethereum) {
                window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                    if (accounts.length > 0) {
                        window.ethereum.request({ method: 'eth_chainId' }).then(chainId => {
                            if (parseInt(chainId, 16) === POLYGON_CHAIN_ID) {
                                provider = new ethers.providers.Web3Provider(window.ethereum);
                                signer = provider.getSigner();
                                userAddress = accounts[0];
                                currentWallet = 'metamask';
                                updateWalletInfo('metamask');
                                walletSelect.value = 'metamask';
                                getUserProfileData();
                            }
                        }).catch(console.error);
                    }
                }).catch(console.error);
            }

            // ========== 钱包事件监听 ==========
            currentProviderInstance = null;
            connectWalletBtn.addEventListener('click', async () => {
                const selectedWallet = walletSelect.value;
                const providerInstance = getInjectedProvider(selectedWallet);
                if (providerInstance && !currentProviderInstance) {
                    currentProviderInstance = providerInstance;
                    providerInstance.on('accountsChanged', (accounts) => {
                        if (accounts.length > 0 && accounts[0] !== userAddress) {
                            userAddress = accounts[0];
                            updateWalletInfo(currentWallet);
                            getUserProfileData();
                        } else {
                            disconnectBtn.click();
                        }
                    });
                    providerInstance.on('chainChanged', (chainId) => {
                        if (parseInt(chainId, 16) !== POLYGON_CHAIN_ID) {
                            alert('请切换到 Polygon 主网！');
                            disconnectBtn.click();
                        } else {
                            getUserProfileData();
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>

